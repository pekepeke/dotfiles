#!/bin/bash

usage() {
  prg_name=`basename $0`
  cat <<EOM
  Usage: $prg_name [-h]
EOM
  exit 1
}

update_for_rhel() {
  # yum update
  while ! sudo dnf update -y ; do
    sleep 1
  done
  sudo dnf autoclean -y
}

update_for_deb() {
  while ! sudo apt update --fix-missing; do
    sleep 1
  done
  sudo apt upgrade -y --fix-missing
  sudo apt autoclean -y
}

update_usual() {
  if ! grep disable-gpu /usr/share/applications/brave-browser.desktop > /dev/null 2>&1 ; then
    sudo perl -i.bak -plane 's/^(Exec=\S+)/$1 --disable-gpu/g' /usr/share/applications/brave-browser.desktop
  fi
  # gvim -c "DppCoreUpdate | DenopsCacheReload | DppUpdate"
  mise self-update -y

  mise outdated
}

main() {
  if [ -f /etc/redhat-release ]; then
    update_for_rhel
  elif [ -f /etc/lsb-release ]; then
    update_for_deb
  fi
  update_usual
}

OPTIND_OLD=$OPTIND
OPTIND=1
while getopts "hvs:" opt; do
  case $opt in
    h)
      usage ;;
    v) ;;
    s)
      #$OPTARG
      ;;
  esac
done
shift `expr $OPTIND - 1`
OPTIND=$OPTIND_OLD
if [ $OPT_ERROR ]; then
  usage
fi

main "$@"

